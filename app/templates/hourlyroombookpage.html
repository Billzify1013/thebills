{% extends "base.html" %}
{% block content %}

{% if messages%}
{% for msg in messages %}
<div class="container mt-0">
    <!-- Success Alert -->
    {% if msg.tags == 'success' %}
    <div id="success-alert" class="alert alert-success alert-dismissible" role="alert">
        {{msg}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {%else%}
    <div id="danger-alert" class="alert alert-danger alert-dismissible" role="alert">
        {{msg}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {%endif%}
</div>
{%endfor%}
<script>
  $(document).ready(function() {
      // Fade out the alert after 5 seconds (5000 milliseconds)
      setTimeout(function() {
          $("#success-alert").fadeTo(500, 0).slideUp(500, function(){
              $(this).remove(); 
          });
      }, 1000);
  });
</script>
{%endif%}
        
<div class="container ">
    {{username}}
    <form action="{% url 'hourlybookingsearch'%}" method="post">
        {% csrf_token %}
        <input type="date" name="startdate" id="startDate" value="{{startdate}}"/><br>
        <input type="time" name="time" id="endDate" value="" /><br>
        <input type="submit" />
      </form>

      

      {{startdate}}=== {{enddate}}

      {{roomsdata}}
      <div class="row">
        <div class="col-10">
            <h6 class="text mt-3">Select All Rooms and Book Full Hotel<input class="form-check-input " style="margin-top:-1px"  type="checkbox" onClick="toggle(this)" /></h6>
        </div>

        <div class="col-2 " >
            <button class="btn btn-primary w-100" id="submitBtn" data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasBackdrop"
            aria-controls="offcanvasBackdrop">Done</button>
        </div>
      </div>

    <div class="row">
      <h4 class="title mb-0 mt-4">Available Rooms</h4>
        {%for i in availableroomdata%} 
        
  <div class="col-2 col-outline-danger  " >
    
    <div class="card mt-3">
    <div class="card-body ">
      <input class="form-check-input" type="checkbox" name="object"  value="{{i.id}} , {{i.price}} , {{i.tax.taxrate}}" id="{{i.id}}"  />
        <center>
            <h4 class="card-title mb-0">{{i.room_name}}</h4> 
            <p class="card-text mb-0">₹{{i.price}}</p>
            <p class="card-text mb-0">Tax:{{i.tax.taxrate}}%</p>
            <span class="badge text-center bg-label-primary ">{{i.room_type}}</span>
          </center>
    
    </div>
    
</div>

</div> 



{%endfor%}



<small class="text-danger  badge bg-label-danger me-1">{{emptymessage}}</small>




</div>


<!--\Advance booking data -->
<div class="row">
  <h5 class="title mb-0 mt-4">Advance Booking</h5> 
  {%for i in bookedroomsdata%}
          
  <div class="col-2 col-outline-danger  " >
      
    <div class="card mt-3">
    <div class="card-body text-muted">
        <center>
            <h4 class="card-title text-muted mb-0">{{i.roomno.room_name}}</h4> 
            <p class="card-text mb-0 " style="font-size:13px">In:{{i.bookingdate}}</p>
            <p class="card-text mb-0" style="font-size:12px">Out:{{i.checkoutdate}}</p>
            <span class="badge text-center bg-label-primary ">{{i.room_type}}</span>
          </center>
    
    </div>
    
  </div>
  
  </div> 
  
  {%endfor%}
  </div>


<!--guest stay data -->
<div class="row">
  <h5 class="title mb-0 mt-4">Guest-Stayed</h5> 
{%for i in guestroomsdata%}
        
<div class="col-2 col-outline-danger  " >
    
  <div class="card mt-3 ">
  <div class="card-body text-muted">
      <center>
          <h4 class="card-title mb-0 text-muted">{{i.roomno}}</h4> 
          <p class="card-text mb-0 " style="font-size:13px">In:{{i.checkindate}}</p>
          <p class="card-text mb-0" style="font-size:12px">Out:{{i.checkoutdate}}</p>
          <span class="badge text-center bg-label-primary ">{{i.room_type}}</span>
        </center>
  
  </div>
  
</div>

</div> 

{%endfor%}
</div>



<!-- Enable backdrop (default) Offcanvas -->
<div class="col-lg-4 col-md-6">
    <div class="mt-3">
 
      <div
        class="offcanvas offcanvas-end"
        tabindex="-1"
        style="width:500px"
        id="offcanvasBackdrop"
        aria-labelledby="offcanvasBackdropLabel"
      >
        <div class="offcanvas-header">
          <h5 id="offcanvasBackdropLabel" class="offcanvas-title">Guest Information!</h5>
          <button
            type="button"
            class="btn-close text-reset"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
          ></button>
        </div>
       
         <!-- Basic Layout & Basic with Icons -->
 <div class="row" >
    <!-- Basic Layout -->
        <div  class="card-header d-flex align-items-center justify-content-between" style="margin-top:-25px">
            <div class="container-fluid"> 
            <small class="text-muted  badge bg-label-primary me-1">Total ₹: <span id="totalamt"></span></small>
            <small class="text-muted text-center badge bg-label-primary ">Total-days : <span id="dayoffs"></span></small>
          <small class="text-muted float-end badge bg-label-primary me-1">Total Select Room : <span id="totalroom"></span></small>
          

            </div>
        </div>
        <div style="margin-top:-80px" class="card-body">
            <div class="container-fluid">
          <form action="{% url 'addadvancebooking'%}" method="post">
            {% csrf_token %}

       {% comment %} <input type="hidden" name="startdate" id="startDate" value="{{startdate}}"/><br>
        <input type="hidden" name="enddate" id="endDate" value="{{enddate}}" /><br> {% endcomment %}


            <input type="hidden" name="noofrom" id="noofroom"/>
            <input type="hidden" value="{{startdate}}" id="startDate"  name="bookingdate" /><br>
            <input type="hidden" value="{{enddate}}" id="endDate"  name="bookenddate" /><br>
            <input type="hidden"  id="dayoffsinput"  name="totalstaydays" /><br>
            <div class="row mb-3">
              <div class="col-sm-6 mt-0">
                <label class="col-sm-2 col-form-label" for="basic-icon-default-fullname">Name</label>
                <div class="input-group input-group-merge">
                  <span id="basic-icon-default-fullname2" class="input-group-text"
                    ><i class="bx bx-user"></i
                  ></span>
                  <input
                    type="text"
                    name = "guestname"
                    class="form-control"
                    id="basic-icon-default-fullname"
                    placeholder="John Doe"
                    aria-label="John Doe"
                    aria-describedby="basic-icon-default-fullname2"
                    required
                  />
                </div>
              </div>

              <div class="col-sm-6">
                <label class="col-sm-2 col-form-label" for="basic-icon-default-fullname">Phone</label>
                <div class="input-group input-group-merge">
                  <span id="basic-icon-default-fullname2" class="input-group-text"
                    ><i class='bx bxs-phone-call' ></i></span>
                  <input
                    type="tel"
                    pattern="[6-9][0-9]{9}"
                    name = "phone"
                    class="form-control"
                    id="basic-icon-default-fullname"
                    placeholder="John Doe"
                    aria-label="John Doe"
                    aria-describedby="basic-icon-default-fullname2"
                    required
                  />
                </div>
              </div>

             

              <div class="col-sm-6 mt-2">
                <label class="col-sm-12 col-form-label" for="basic-icon-default-fullname">Booking-Gives</label>
                <div class="input-group input-group-merge">
                  <span id="basic-icon-default-fullname2" class="input-group-text"
                    ><i class='bx bxs-down-arrow'></i></span>
                    <select class="form-control" name="channal" placeholder="Select Category">
                        {%for cat in channal%}
                        <option  value="{{cat.id}}">{{cat}}</option>
                        
                        {%endfor%}
                      </select>
                </div>
              </div>

              

              <div class="col-sm-6 mt-2">
                <label class="col-sm-12 col-form-label" for="basic-icon-default-fullname">Total-Amount</label>
                <div class="input-group input-group-merge">
                  <span id="basic-icon-default-fullname2" class="input-group-text"
                    >₹</span>
                  <input
                    type="number"
                    name = "totalamount"
                    class="form-control"
                    id="totalamountinput"
                    placeholder="John Doe"
                    aria-label="John Doe"
                    aria-describedby="basic-icon-default-fullname2"
                  />
                </div>
                <small class="text-muted float-end badge bg-label-primary me-1">Total Amount INCL GST. </small>
              </div>

              <div class="col-sm-6 mt-2">
                <label class="col-sm-12 col-form-label" for="basic-icon-default-fullname">Advance-Amount</label>
                <div class="input-group input-group-merge">
                  <span id="basic-icon-default-fullname2" class="input-group-text"
                    >₹</span>
                  <input
                    type="number"
                    value=0
                    name = "advanceamount"
                    class="form-control"
                    id="advanceamountinput"
                    placeholder="John Doe"
                    aria-label="John Doe"
                    aria-describedby="basic-icon-default-fullname2"
                  />
                </div>
              </div>

              <div class="col-sm-6 mt-2">
                <label class="col-sm-12 col-form-label" for="basic-icon-default-fullname">Discount-Amount</label>
                <div class="input-group input-group-merge">
                  <span id="basic-icon-default-fullname2" class="input-group-text"
                    >₹</span>
                  <input
                    type="number"
                    value=0
                    name = "discountamount"
                    class="form-control"
                    id="discountamountinput"
                    placeholder="John Doe"
                    aria-label="John Doe"
                    aria-describedby="basic-icon-default-fullname2"
                  />
                </div>
                <small class="text-warning float-end badge bg-label-warning " style="font-size:10px">It Will Add On Billing Time Not Yet </small>
              </div>

              <div class="col-sm-12 mt-2">
                <label class="col-sm-12 col-form-label" for="basic-icon-default-fullname">Reamaining-Amount</label>
                <div class="input-group">
                    <span id="basic-icon-default-fullname2" class="input-group-text"
                    >₹</span>
                    <input
                      type="number"
                      name = "reaminingamount"
                      class="form-control"
                      readonly
                      value=0
                      id="reamainingamountinput"
                      placeholder="Reamaining amount"
                      aria-label="Recipient's username"
                      aria-describedby="button-addon2"
                      {% comment %} onClick="calculateamount()" {% endcomment %}
                    />
                  </div>
              </div>

              <div class="col-sm-12 mt-4">
                <div class="input-group">
                    <input type="hidden" id="new" name="news"/>
                    <input class="form-check-input" id="checkboxinp"  type="checkbox" onClick="calculateamount()"  required/>
                    <span class="text ms-2">Click To Get Correct Data. </span>
                  </div>
              </div>

             

            
            
              <div class="col-sm-12 mt-4">
                <button type="submit" class="btn btn-primary w-100">Send</button>
              </div>
            
          </form>
        </div>
<!-- / Content -->
    
    </div>
    </div>
  </div>


<script>

    function toggle(source) {
        checkboxes = document.getElementsByName('object');
        for(var i=0, n=checkboxes.length;i<n;i++) {
          checkboxes[i].checked = source.checked;
        }
      }




//room counting data get to backend
//counting date data
$(document).ready(function(){
    $("#submitBtn").click(function(){

        //counting date data
        // Get the values of the input fields
        var startDateStr = $("#startDate").val();
        var endDateStr = $("#endDate").val();

        // Convert the input values to Date objects
        var startDate = new Date(startDateStr);
        var endDate = new Date(endDateStr);

        // Calculate the difference in milliseconds
        var timeDiff = endDate.getTime() - startDate.getTime();

        // Convert milliseconds to days
        var daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
        
        if (daysDiff === 0){
          daysDiff = 1
        }
        // Display the result
        $("#result").text("Number of days: " + daysDiff);
       

        //room counting data start
        var selectedData = [];
        var total_amount = 0;
        var taxamount = 0;
        $("input[name='object']:checked").each(function(){
            var value = $(this).val();
            var id = value.split(',')[0];
            var price = value.split(',')[1];
            var tax = value.split(',')[2];
            price = parseInt(price)
            tax = parseInt(tax)
            selectedData.push({id: id, price: price, tax:tax});
            taxamount = (price * tax) /100;
            var total_price = price + taxamount;
            total_amount += total_price;
           // taxamount = total_amount * tax /100
           // console.log(taxamount)
           // total_amount = total_amount + taxamount
           // console.log(total_amount)
            
        });
        
        total_amount = total_amount * daysDiff
        total_amount = parseInt(total_amount)
        // Do something with the selected data (ID and name)
        var l =selectedData.length;
        $('#totalamt').html(total_amount);
        $('#totalamountinput').val(total_amount);
        var serializedArray = JSON.stringify(selectedData);
        $('#new').val(serializedArray);
        $('#totalroom').html(l);
        $('#dayoffs').html(daysDiff);
        $('#dayoffsinput').val(daysDiff);
        $('#noofroom').val(l);
        selectedData = []
        document.getElementById('checkboxinp').checked = false;
    });
});



// Calculate remaining amount and discount
function calculateamount() {
  var totalamt = parseFloat($('#totalamountinput').val());
  var advanceamt = parseFloat($('#advanceamountinput').val());
  var discamt = parseFloat($('#discountamountinput').val());

  // Counting date data
  var startDateStr = $("#startDate").val();
  var endDateStr = $("#endDate").val();

  var startDate = new Date(startDateStr);
  var endDate = new Date(endDateStr);

  var timeDiff = endDate.getTime() - startDate.getTime();
  var daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));
  
  if (daysDiff === 0) {
      daysDiff = 1;
  }
  $("#result").text("Number of days: " + daysDiff);

  // Room counting data start
  var selectedData = [];
  var totalroomcount = parseInt($('#totalroom').html());
  
  var total_amount = 0;
  var taxamount = 0;
  var remainingDiscount = discamt/totalroomcount;

  $("input[name='object']:checked").each(function() {
      var value = $(this).val();
      var id = value.split(',')[0];
      var price = parseFloat(value.split(',')[1]);
      var tax = parseFloat(value.split(',')[2]);

      price *= daysDiff;
      if (remainingDiscount > 0) {
          if (remainingDiscount >= price) {
              remainingDiscount -= price;
              price = 0;
          } else {
              price -= remainingDiscount;
          }
      }
      console.log(price)
      taxamount = parseInt(price * tax) / 100;
      var total_price = price + taxamount;
      total_amount += total_price;

      selectedData.push({id: id, price: price, tax: tax});
  });

  total_amount = parseInt(total_amount);

  $('#totalamt').html(total_amount);
  $('#totalamountinput').val(total_amount);
  var serializedArray = JSON.stringify(selectedData);
  $('#new').val(serializedArray);
  $('#totalroom').html(selectedData.length);
  $('#dayoffs').html(daysDiff);
  $('#dayoffsinput').val(daysDiff);
  $('#noofroom').val(selectedData.length);

  var subtotal = total_amount - advanceamt;
  $('#reamainingamountinput').val(subtotal);
}


</script>

</body>
</html>

   


        








   

<!-- Jquery -->
   <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
   <!-- Bootstrap Bundle with Popper -->
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

   {% if messages %}
   {% for msg in messages %}
   <div class=" alert alert-danger text-center mt-3" role="alert">{{msg}}</div>
   {%endfor%}
{%endif%}


   


  {% endblock %}