{% extends "base.html" %}
{% block content %}


{% if messages%}
{% for msg in messages %}
<div class="container mt-0">
    <!-- Success Alert -->
    {% if msg.tags == 'success' %}
    <div id="success-alert" class="alert alert-success alert-dismissible" role="alert">
        {{msg}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {%else%}
    <a href="{% url 'billingplanpage' %}" style="text-decoration:none;">
    <div id="danger-alert" class="alert alert-danger alert-dismissible" role="alert">
        {{msg}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div></a>
    {%endif%}
</div>
{%endfor%}
<script>
  $(document).ready(function() {
      // Fade out the alert after 5 seconds (5000 milliseconds)
      setTimeout(function() {
          $("#success-alert").fadeTo(500, 0).slideUp(500, function(){
              $(this).remove(); 
          });
      }, 1000);
  });
</script>
{%endif%} 




{%if invcdata%}
{%else%}
<h6 class="text">Make Invoice For Spa,Gym,Food and Many More. </h6>
<div class="row ">
    <div class="col-12 mb-4">
        <div class="card">
            <form action="{% url 'addaminitiesinvoice' %}" method="post">
                {% csrf_token %}
            <div class="bg-light m-5 mb-0">
                <div class="row">
                    <div class="col-8">
                        {%for i in profiledata%}
                        
                        <p class="text fw-light ps-4 mt-4 p-2" style="font-size:12px">
                            {{i.name}}<br>
                            ADDRESS: {{i.address}} {{i.counrty}}<br>
                            EMAIL: {{i.email}}<br>
                            PHONE: {{i.contact}}<br>
                            GST: {{i.gstin}}
                        </p>

                        {%endfor%}
                    </div>
                    

                    <script>
                        document.addEventListener("DOMContentLoaded", function() {
                            // Get today's date
                            const today = new Date();
                            
                            // Format the date as YYYY-MM-DD
                            const year = today.getFullYear();
                            const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are zero-indexed
                            const day = String(today.getDate()).padStart(2, '0');
                            const formattedDate = `${year}-${month}-${day}`;
                
                            // Set the value of the date input
                            document.getElementById('dateInput').value = formattedDate;
                        });
                    </script>
                    <div class="col-2">
                        <p class="text mt-3">
                            INVOICE <br>
                            Invoice Date:<input type="date" id="dateInput" class="form-control" name="invcdate"> <br>

                        </p>
                    </div>
                    

                </div>
            </div>
            <div id="user_details" class="m-2 ms-5"></div>
            <div id="checkbox_container" style="margin-top: 10px; display: none;" class="ms-5">
                <input type="checkbox" id="auto_fill" /> <label for="auto_fill">Use this information to fill the form</label>
            </div>
            <!--customer data-->
            <div class="row m-4 mt-0 p-3 mb-0">
                <p>Customer Details</p>
            <div class="col-4 ">
                <span class="text"><i class='bx bx-user'></i>Customer Name</span>
                <input  type="text" class="form-control mt-2 " name="cname" placeholder="customer name" required>
            </div>
            <div class="col-4 ">
                <span class="text"><i class='bx bx-phone'></i>Customer Contact</span>
                <a id="search_button" style="height:30px;" class="btn btn-primary float-end text-white mt-0"><i class="bx bx-search fs-5 lh-0 "></i></a>
                <input  type="tel"
                pattern="[6-9][0-9]{9}" class="form-control mt-2 " name="contact" placeholder="customer contact"
                id="mobile_number" 
                required />
            </div>
            <div class="col-4 ">
                <span class="text"><i class='bx bx-mail-send'></i>Customer Email</span>
                <input  type="email" class="form-control mt-2 " name="email" placeholder="customer email" required>
            </div>
      

        
            <div class="col-4 mt-3">
                <span class="text"><i class='bx bx-location-plus'></i>Customer Address</span>
                <input  type="text" class="form-control mt-2 " name="address" placeholder="customer address" required>
            </div>

            <div class="col-4 mt-3">
                <span class="text"><i class='bx bx-location-plus'></i>Customer State</span>
                <select id="country" name="STATE" required placeholder="select States" class="select2 form-select mt-2">
                    <option value="">Select States</option>
                    <optgroup label="Indian States">
                    <option value="andhra_pradesh">Andhra Pradesh</option>
                    <option value="arunachal_pradesh">Arunachal Pradesh</option>
                    <option value="assam">Assam</option>
                    <option value="bihar">Bihar</option>
                    <option value="chhattisgarh">Chhattisgarh</option>
                    <option value="goa">Goa</option>
                    <option value="gujarat">Gujarat</option>
                    <option value="haryana">Haryana</option>
                    <option value="himachal_pradesh">Himachal Pradesh</option>
                    <option value="jharkhand">Jharkhand</option>
                    <option value="karnataka">Karnataka</option>
                    <option value="kerala">Kerala</option>
                    <option value="madhya_pradesh">Madhya Pradesh</option>
                    <option value="maharashtra">Maharashtra</option>
                    <option value="manipur">Manipur</option>
                    <option value="meghalaya">Meghalaya</option>
                    <option value="mizoram">Mizoram</option>
                    <option value="nagaland">Nagaland</option>
                    <option value="odisha">Odisha</option>
                    <option value="punjab">Punjab</option>
                    <option value="rajasthan">Rajasthan</option>
                    <option value="sikkim">Sikkim</option>
                    <option value="tamil_nadu">Tamil Nadu</option>
                    <option value="telangana">Telangana</option>
                    <option value="tripura">Tripura</option>
                    <option value="uttar_pradesh">Uttar Pradesh</option>
                    <option value="uttarakhand">Uttarakhand</option>
                    <option value="west_bengal">West Bengal</option>
                </optgroup>
                <optgroup label="Union Territories">
                    <option value="andaman_and_nicobar_islands">Andaman and Nicobar Islands</option>
                    <option value="chandigarh">Chandigarh</option>
                    <option value="dadra_and_nagar_haveli_and_daman_and_diu">Dadra and Nagar Haveli and Daman and Diu</option>
                    <option value="lakshadweep">Lakshadweep</option>
                    <option value="delhi">Delhi</option>
                    <option value="puducherry">Puducherry</option>
                    <option value="ladakh">Ladakh</option>
                    <option value="jammu_and_kashmir">Jammu and Kashmir</option>
                </optgroup>
                <optgroup label="Other Locations">
                    <option value="foreign">Foreign</option>
                </optgroup>
              </select> </div>

            <div class="col-4 mt-3">
                <span class="text">Customer Gstin</span>
                <input  type="text" maxlength="15" class="form-control mt-2 " name="customergstno"  placeholder="customer Gst number">
            </div>
            <div class="col-4 mt-3">
                <span class="text">Customer Company</span>
                <input  type="text" maxlength="48" class="form-control mt-2 " name="companyname" placeholder="company name" >
            </div>
        </div>
        <!--customer data end-->

    <!--Product data-->
        <div class="row m-4 mt-0 p-3">
             <!-- Suggestions List -->
    <div id="product_suggestions" class="mt-3 bg-light">
        <!-- Suggestions will be displayed here dynamically -->

        
    </div>
   
            <p>Product Details</p>
         <!-- Checkbox Container for autofill -->
<div id="checkboxes_container" style="margin-top: 10px; display: none;">
    <input type="checkbox" id="auto_fill_product" /> 
    <label for="auto_fill_product">Use this information to fill the product details</label>
</div>
        <div class="col-4 ">
            <span class="text"><i class='bx bx-unite'></i>Product description</span>
            <input  type="text" class="form-control mt-2 " id="product_name" name="productname" required>
        </div>
        <div class="col-4 ">
            <span class="text"><i class='bx bx-money'></i>Selling  Price</span>
            <input  type="number" class="form-control mt-2 " name="productprice" required>
        </div>
        <div class="col-4 ">
            <span class="text">Quantity</span>
            <input  type="number" class="form-control mt-2 " name="productqty" required>
        </div>
  

    
        <div class="col-4 mt-3">
            <span class="text">Tax %</span>
            <input  type="number" class="form-control mt-2 "  name="producttax" >
        </div>
        <div class="col-4 mt-3">
            <span class="text">HSN/SAC</span>
            <input  type="text" class="form-control mt-2 " name="producthsn" >
        </div>
        <div class="col-4 mt-3">
            <span class="text"><i class='bx bxs-discount'></i>Discount</span>
            <input  type="number" class="form-control mt-2 " name="productdiscount" >
        </div>

        <div class="col-4 mt-3 end-0">
            <input  type="submit" class="btn btn-primary" value="Save Customer & Add More Item">
        </div>
    </div> 


    <!--product data end-->
    </form>

    
            
        </div>
    </div>
    <div class=" col-3">
        {% comment %} <button class="btn btn-primary w-100">Save</button>
        <button class="btn btn-primary w-100 mt-1">Print</button>
        <button class="btn btn-primary w-100 mt-1">Donwload</button>
        <button class="btn btn-danger w-100 mt-1">Delete</button> {% endcomment %}
    </div>
</div>

{%endif%}


<script>
    $(document).ready(function() {
        var selectedProduct = {};  // Store the selected product's data in an object
    
        // When the user types in the product name input field
        $('#product_name').on('input', function() {
            var product_name = $(this).val().trim();
        
            // If the input is not empty
            if (product_name.length > 0) {
                // Perform an AJAX request to search for matching products
                $.ajax({
                    url: '/check_product/',  // The URL where the backend is handling the search
                    type: 'GET',
                    data: {
                        'product_name': product_name
                    },
                    success: function(response) {
                        if (response.success) {
                            // Show product suggestions dynamically with checkboxes
                            var suggestionsHTML = '';
                            response.products.forEach(function(product) {
                                suggestionsHTML += `
                                    <div data-product-id="${product.id}" class="product-suggestion">
                                        <p><strong>Product:</strong> ${product.description}</p> <!-- Product name (description) -->
                                        <p><strong>Price:</strong> ₹${product.price}</p>
                                        <p><strong>HSN Code:</strong> ${product.hsncode ? product.hsncode : ''}</p>
                                        <p><strong>Tax Rate:</strong> ${product.category_tax ? product.category_tax + '%' : ''}</p>
                                        <input type="checkbox" class="auto_fill_checkbox" data-product-id="${product.id}" />
                                        <label for="auto_fill_checkbox">Use this information</label>
                                    </div>
                                `;
                            });
                            $('#product_suggestions').html(suggestionsHTML);
                        } else {
                            // Show a message if no products were found
                            $('#product_suggestions').html('<p>No products found matching the input.</p>');
                        }
                    },
                    error: function() {
                        $('#product_suggestions').html('<p>An error occurred. Please try again later.</p>');
                    }
                });
            } else {
                // Clear suggestions if the input is empty
                $('#product_suggestions').html('');
            }
        });
    
        // When a user clicks on a product suggestion checkbox, autofill the input fields
        $(document).on('change', '.auto_fill_checkbox', function() {
            var isChecked = $(this).prop('checked');
            var productId = $(this).data('product-id');
    
            // Find the selected product in the suggestions list
            $('#product_suggestions .product-suggestion').each(function() {
                if ($(this).data('product-id') === productId) {
                    // Store all the product data in the object, using consistent <p> tag extraction
                    selectedProduct = {
                        description: $(this).find('p').eq(0).text().replace('Product:', '').trim(),  // Extract the product name from the first <p> tag
                        price: $(this).find('p').eq(1).text().replace('Price:', '').replace('₹', '').trim(), // Extract the price
                        hsncode: $(this).find('p').eq(2).text().replace('HSN Code:', '').trim(), // Extract HSN code
                        category_tax: $(this).find('p').eq(3).text().replace('Tax Rate:', '').replace('%', '').trim() // Extract Tax Rate
                    };
                }
            });

            // If the checkbox is checked, autofill the fields
            if (isChecked && selectedProduct.description) {
                // Autofill only the product name in the "productname" input field
                $('input[name="productname"]').val(selectedProduct.description || '');  // Set only product name

                // Fill other fields with the corresponding data
                $('input[name="productprice"]').val(selectedProduct.price || '');  // Set product price
                $('input[name="productqty"]').val(1);  // Default quantity

                // Only fill tax if available, else leave it empty
                $('input[name="producttax"]').val(selectedProduct.category_tax || '');  // Empty if no tax

                // Only fill HSN code if available, else leave it empty
                $('input[name="producthsn"]').val(selectedProduct.hsncode || '');  // Empty if no HSN

                $('input[name="productdiscount"]').val(0);  // Default discount
            } else {
                // If unchecked, clear the fields
                $('input[name="productname"]').val('');  // Clear product name field
                $('input[name="productprice"]').val('');
                $('input[name="productqty"]').val('');
                $('input[name="producttax"]').val('');
                $('input[name="producthsn"]').val('');
                $('input[name="productdiscount"]').val('');
            }
        });
    });
</script>





    




<!--existing invoice-->
{%if invcdata%}

<div class="row ">
    <p class="text-danger">Invoice Already Exists! Please Sattle/Delete This Invoice.</p>
    <div class="col-9 mb-4">
        <div class="card">
            <div class="bg-light m-5 mb-0">
                <div class="row">
                    <div class="col-8">
                        {%for i in profiledata%}
                        
                        <p class="text fw-light ps-4 mt-4 p-2" style="font-size:12px">
                            {{i.name}}<br>
                            ADDRESS: {{i.address}} {{i.counrty}}<br>
                            EMAIL: {{i.email}}<br>
                            PHONE: {{i.contact}}<br>
                            GST: {{i.gstin}}
                        </p>

                        {%endfor%}
                    </div>
                    <div class="col-2">
                        <p class="text mt-3">
                            INVOICE: {{invcdata.invoicenumber}} <br>
                            Date Issued: {{invcdata.invoicedate}} <br>
                            

                        </p>
                    </div>

                </div>
            </div>
            
            <!--customer data-->
            <div class="row m-4 mt-0 p-3 mb-0">
                <p>Customer Details</p>
            <div class="col-4 ">
                <span class="text"><i class='bx bx-user'></i>Customer Name</span>
                <input  type="text" class="form-control mt-2 " name="cname" value="{{invcdata.customername}}" placeholder="customer name" required>
            </div>
            <div class="col-4 ">
                <span class="text"><i class='bx bx-phone'></i>Customer Contact</span>
                <input  type="tel"
                pattern="[6-9][0-9]{9}" class="form-control mt-2 " name="contact" value="{{invcdata.customercontact}}" placeholder="customer contact" required>
            </div>
            <div class="col-4 ">
                <span class="text"><i class='bx bx-mail-send'></i>Customer Email</span>
                <input  type="email" class="form-control mt-2 " name="email" value="{{invcdata.customeremail}}" placeholder="customer email" required>
            </div>
      

        
            <div class="col-4 mt-3">
                <span class="text"><i class='bx bx-location-plus'></i>Customer Address</span>
                <input  type="text" class="form-control mt-2 " name="address" value="{{invcdata.customeraddress}}" placeholder="customer address" required>
            </div>

            <div class="col-4 mt-3">
                <span class="text"><i class='bx bx-location-plus'></i>Billing Type</span>
                <input  type="text" class="form-control mt-2 " readonly name="" value="{{invcdata.taxtype}}" placeholder="customer address" required>
              
            </div>

            <div class="col-4 mt-3">
                <span class="text">Customer Gstin</span>
                <input  type="text" maxlength="15" class="form-control mt-2 " value="{{invcdata.customergst}}"  name="customergstno"  placeholder="customer Gst number">
            </div>
            <div class="col-4 mt-3">
                <span class="text">Customer Company</span>
                <input  type="text" maxlength="48" class="form-control mt-2 " value="{{invcdata.customercompany}}" name="companyname" placeholder="company name" >
            </div>
        </div>
        <!--customer data end-->

        <!--existing products details -->

        {%if invoiceitemsdata%}
            <!-- Bootstrap Table with Header - Light -->
 <div class="card mt-4 m-5"  >
    <h5 class="card-header" >Existing Product</h5>
    <div class="table-responsive text-nowrap">
      <table class="table">
        <thead class="table-light">
          <tr>
            <th>Iteam</th>
            <th>Price</th>
            <th>Qty</th>
            <th>Tax HSN</th>
            <th>Total</th>
            <th>Discount</th>
            <th>Subtotal</th>
            <th>taxamount</th>
            <th>Grandtotal</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody class="table-border-bottom-0">

            {%for data in invoiceitemsdata%}
          <tr>
            <td> <strong>{{data.description}}</strong></td>
            <td>{{data.price}}</td>
            <td>
              {{data.quantity}}
            </td>
              <td><span class="badge bg-label-primary me-1">{{data.tax_rate}}% {{data.hsncode}}</span></td>
        
            <td>{{data.total_amount}}</td>
            <td>
              {{data.discount_amount}}
            
            </td>
            <td>{{data.subtotal_amt}}</td>
            <td>{{data.tax_amt}}</td>
            <td>{{data.grand_total}}</td>
            <td>
                
                      <button
                        type="button"
                        class="btn  dropdown-toggle hide-arrow"
                        data-bs-toggle="dropdown"
                        aria-haspopup="true"
                        aria-expanded="false"
                        
                      >
                      <i class="bx bx-dots-vertical-rounded"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'aminitiesitemdelete' id=data.id %}"><i class="bx bx-trash me-1"></i> Delete</a></li>
                        
                      </ul>
                    
            </td>
          </tr>
          {%endfor%}
   
        
        </tbody>
      </table>
    </div>
  </div>
  <!-- Bootstrap Table with Header - Light -->

{%endif%}
  
    <div class="col-7 p-4">
        <div class="border-1  ps-4">
            <li class="list-group-item">
                <b><span class="text w-50">Total</span></b> 
                <span class="text float-end"><strong>{{invcdata.total_item_amount}}</strong></span><br>
                <b><span class="text w-50">Discount</span></b> 
                <span class="text float-end"><strong>{{invcdata.discount_amount}}</strong></span><br>
                <b><span class="text w-50">Subtotal</span></b> 
                <span class="text float-end"><strong>{{invcdata.subtotal_amount}}</strong></span><br>
                <b><span class="text w-50">Tax Amount</span></b> 
                <span class="text float-end"><strong>{{invcdata.gst_amount|add:invcdata.sgst_amount}}</strong></span><hr>
                <b><span class="text w-50">Grand Total</span></b> 
                <span class="text float-end"><strong>{{invcdata.grand_total_amount}}</strong></span>
               
        </div>
    </div>

        <!--existing products data end-->


        <div class="tab-content">
            <!--loylty div start-->
            <div class="tab-pane fade show active" id="navs-pills-justified-Amenities" role="tabpanel">
                
                <div class="col-12 mb-5 w-100">
                    <button
                    type="button"
                      class="btn btn-primary mb-4 float-end"
                      data-bs-toggle="collapse"
                      href="#multiCollapseExample1"
                      role="button"
                      aria-expanded="false"
                      aria-controls="multiCollapseExample1"

                      ><i class='bx bxs-plus-circle mb-1'></i> Add More Products </button>
                    
                </div>
                <br>
                <div class="col-xxl mt-3 w-100  mb-md-0">
                        <div class="collapse multi-collapse w-100" id="multiCollapseExample1">
             

    <form action="{% url 'addmoreaminitiesproductininvoice' %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="invcid" value="{{invcdata.id}}">
        
        <!-- Product data -->
        <div class="row m-4 mt-0 p-3">
            <p>Product Details</p>
            <div id="product_suggestions_invoice" class="w-100 bg-light"></div> <!-- Product suggestions with checkboxes -->
    
            <div class="col-4">
                <span class="text"><i class='bx bx-unite'></i>Product Name</span>
                <input type="text" class="form-control mt-2" id="product_name_invoice" name="productname" required>
            </div>
            <div class="col-4">
                <span class="text"><i class='bx bx-money'></i>Selling Price</span>
                <input type="number" class="form-control mt-2" name="productprice" required>
            </div>
            <div class="col-4">
                <span class="text">Quantity</span>
                <input type="number" class="form-control mt-2" name="productqty" required>
            </div>
    
            <div class="col-4 mt-3">
                <span class="text">Tax %</span>
                <input type="number" class="form-control mt-2" name="producttax">
            </div>
            <div class="col-4 mt-3">
                <span class="text">HSN/SAC</span>
                <input type="text" class="form-control mt-2" name="producthsn">
            </div>
            <div class="col-4 mt-3">
                <span class="text"><i class='bx bxs-discount'></i>Discount</span>
                <input type="number" class="form-control mt-2" name="productdiscount">
            </div>
    
            <div class="col-4 mt-3 end-0">
                <input type="submit" class="btn btn-primary" value="Save Customer & Add More Item">
            </div>
        </div>
        <!-- Product data end -->
    </form>
    
    
    <script>
        $(document).ready(function() {
            var selectedProductInvoice = {};  // Store the selected product's data for this form
        
            // When the user types in the product name input field (on the second form)
            $('#product_name_invoice').on('input', function() {
                var product_name = $(this).val().trim();
        
                // If the input is not empty
                if (product_name.length > 0) {
                    // Perform an AJAX request to search for matching products
                    $.ajax({
                        url: '/check_product/',  // The URL where the backend is handling the search
                        type: 'GET',
                        data: {
                            'product_name': product_name
                        },
                        success: function(response) {
                            if (response.success) {
                                // Show product suggestions dynamically with checkboxes
                                var suggestionsHTML = '';
                                response.products.forEach(function(product) {
                                    suggestionsHTML += `
                                        <div data-product-id="${product.id}" class="product-suggestion">
                                            <p><strong>Product:</strong> ${product.description}</p>
                                            <p><strong>Price:</strong> ₹${product.price}</p>
                                            <p><strong>HSN Code:</strong> ${product.hsncode ? product.hsncode : ''}</p>
                                            <p><strong>Tax Rate:</strong> ${product.category_tax ? product.category_tax + '%' : ''}</p>
                                            <input type="checkbox" class="auto_fill_checkbox_invoice" data-product-id="${product.id}" />
                                            <label for="auto_fill_checkbox_invoice">Use this information</label>
                                        </div>
                                    `;
                                });
                                $('#product_suggestions_invoice').html(suggestionsHTML);
                            } else {
                                // Show a message if no products were found
                                $('#product_suggestions_invoice').html('<p>No products found matching the input.</p>');
                            }
                        },
                        error: function() {
                            $('#product_suggestions_invoice').html('<p>An error occurred. Please try again later.</p>');
                        }
                    });
                } else {
                    // Clear suggestions if the input is empty
                    $('#product_suggestions_invoice').html('');
                }
            });
        
            // When a user clicks on a product suggestion checkbox, autofill the input fields for the invoice form
            $(document).on('change', '.auto_fill_checkbox_invoice', function() {
                var isChecked = $(this).prop('checked');
                var productId = $(this).data('product-id');
        
                // Find the selected product in the suggestions list
                $('#product_suggestions_invoice .product-suggestion').each(function() {
                    if ($(this).data('product-id') === productId) {
                        // Store only the description (product name) and the other data as needed
                        selectedProductInvoice = {
                            description: $(this).find('p').eq(0).text().replace('Product:', '').trim(),  // Only extract the product name from the strong tag
                            price: $(this).find('p').eq(1).text().replace('Price: ₹', '').trim(),
                            hsncode: $(this).find('p').eq(2).text().replace('HSN Code: ', '').trim(),
                            category_tax: $(this).find('p').eq(3).text().replace('Tax Rate: ', '').replace('%', '').trim()
                        };
                    }
                });
        
                // If the checkbox is checked, autofill the fields
                if (isChecked && selectedProductInvoice.description) {
                    // Autofill only the product name in the "productname" input field for this form
                    $('input[name="productname"]').val(selectedProductInvoice.description || '');  // Set only product name
                    $('input[name="productprice"]').val(selectedProductInvoice.price || '');  // Set product price
                    $('input[name="productqty"]').val(1);  // Default quantity
        
                    // Only fill tax if available, else leave it empty
                    $('input[name="producttax"]').val(selectedProductInvoice.category_tax || '');  // Empty if no tax
        
                    // Only fill HSN code if available, else leave it empty
                    $('input[name="producthsn"]').val(selectedProductInvoice.hsncode || '');  // Empty if no HSN
        
                    $('input[name="productdiscount"]').val(0);  // Default discount
                } else {
                    // If unchecked, clear the fields
                    $('input[name="productname"]').val('');  // Clear product name field
                    $('input[name="productprice"]').val('');
                    $('input[name="productqty"]').val('');
                    $('input[name="producttax"]').val('');
                    $('input[name="producthsn"]').val('');
                    $('input[name="productdiscount"]').val('');
                }
            });
        });
        
    </script>
    

    </div></div></div></div>


        
            
        </div>
    </div>
    <div class=" col-3">
        <form action="{%  url 'saveaminitiesinvoice' %}" method="post">
            {% csrf_token %}
        <div class="row  mt-0 mb-3 ">
            <p>Payment Details</p>
            <input type="hidden" value="{{invcdata.id}}"  name="invoiceid"/>
        <div class="col-12 ">
            <select  name="paymentmode" id="selectValue" onchange="showinput()" required placeholder="select Payment Mode" class="select2 form-select mt-2">
                <option value="">Select Payment mode</option>
                <option value="cash">Cash</option>
                <option value="online">Online</option>
                <option value="Partly">Partially</option>

            </select>
        </div>

        <div class="col-12 mt-3" style="display:none" id="inputcash">
            <span class="text">Cash Amount</span>
            <input  type="number" class="form-control mt-2 " value=0.00 placeholder="Cash Amount" name="cashamount" >
        </div>

        <div class="col-12 mt-3" style="display:none" id="inputonline">
            <span class="text">Online Amount</span>
            <input  type="number" class="form-control mt-2 " value=0.00 placeholder="Online Amount" name="onlineamount" >
        </div>
    </div>

       <button type="submit" class="btn btn-primary w-100">Save</button>

</form>
        <a href="{% url 'deleteaminitesinvc' id=invcdata.id %}"><button class="btn btn-danger w-100 mt-3">Delete</button> </a>
    </div>
</div>



<script>
function showinput() {
    var selectElement = document.getElementById('selectValue');
    var selectedValue = selectElement.value;
    document.getElementById('inputcash').style.display="none";
    document.getElementById('inputonline').style.display="none";
    if (selectedValue == "Partly"){
    document.getElementById('inputcash').style.display="block";
    document.getElementById('inputonline').style.display="block";
    document.getElementById('nameBackdrop').style.display="block";
    document.getElementById('nameBackdrops').style.display="block";
    document.getElementById('duedateinput').style.display="none";
    }
    else if (selectedValue == "unpaid"){
        document.getElementById('duedateinput').style.display="block";
    }
    else {
        document.getElementById('inputcash').style.display="none";
    document.getElementById('inputonline').style.display="none";
    document.getElementById('nameBackdrop').style.display="none";
    document.getElementById('nameBackdrops').style.display="none";
    document.getElementById('duedateinput').style.display="none";
    }

};
</script>





{%endif%}


 

   


    <script>
        $(document).ready(function() {
            // Event listener for the search button
            $('#search_button').on('click', function() {
                // Get the mobile number entered in the input field
                var mobile_number = $('#mobile_number').val().trim();
                console.log("Mobile number entered:", mobile_number);  // Log entered value
    
                // Sanitize the input to remove non-numeric characters
                var sanitized_number = mobile_number.replace(/\D/g, '');
                console.log("Sanitized number:", sanitized_number);
    
                // Check if 10 digits are entered
                if (sanitized_number.length === 10) {
                    console.log("10 digits entered, ready to send AJAX request");
    
                    // Example AJAX request (replace with your backend URL)
                    $.ajax({
                        url: '/search_user/',  // Your Django endpoint
                        type: 'GET',
                        data: { 'mobile_number': sanitized_number },
                        success: function(response) {
                            console.log(response);  // Log the response from the server
                            if (response.success) {
                                var user = response.user;
                                var user_details = `
                                    <h6>Previous Details</h6>
                                    <p><strong>Name:</strong> ${user.name}, <strong>Email:</strong> ${user.email}, <strong>Mobile:</strong> ${user.mobile}</p>
                                    <p><strong>Address:</strong> ${user.address}, <strong>Company:</strong> ${user.customercompany}, <strong>GST Number:</strong> ${user.customergst}</p>
                                `;
                                $('#user_details').html(user_details);
    
                                // Show the checkbox to autofill form
                                $('#checkbox_container').show();
    
                                // When the checkbox is clicked, autofill the input fields
                                $('#auto_fill').on('change', function() {
                                    if ($(this).prop('checked')) {
                                        // Autofill the form fields with the user data
                                        $('input[name="cname"]').val(user.name);
                                        $('input[name="contact"]').val(user.mobile);
                                        $('input[name="email"]').val(user.email);
                                        $('input[name="address"]').val(user.address);
                                        $('input[name="customergstno"]').val(user.customergst);
                                        $('input[name="companyname"]').val(user.customercompany);
                                        $('select[name="STATE"]').val(user.state); // You may need to adjust this if you have a mapping for the state
                                    } else {
                                        // Clear the fields if unchecked
                                        $('input[name="cname"]').val('');
                                        $('input[name="contact"]').val('');
                                        $('input[name="email"]').val('');
                                        $('input[name="address"]').val('');
                                        $('input[name="customergstno"]').val('');
                                        $('input[name="companyname"]').val('');
                                        $('select[name="STATE"]').val('');
                                    }
                                });
    
                            } else {
                                $('#user_details').html('<p>No user found with this mobile number.</p>');
                                $('#checkbox_container').hide(); // Hide the checkbox if no user found
                            }
                        },
                        error: function() {
                            $('#user_details').html('<p>An error occurred. Please try again later.</p>');
                            $('#checkbox_container').hide(); // Hide the checkbox on error
                        }
                    });
                } else {
                    $('#user_details').html('<p>Please enter a valid 10-digit mobile number.</p>');
                    $('#checkbox_container').hide(); // Hide the checkbox if input is invalid
                }
            });
        });
    </script>
    
{%endblock%}